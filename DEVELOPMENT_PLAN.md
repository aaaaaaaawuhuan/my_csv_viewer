# CSV Viewer 开发计划

## 项目概述

开发一个基于 Qt 的 CSV 文件查看器，能够处理 100MB 级别的大文件，提供高效的浏览和筛选功能。

## 功能需求

1. 初始化时读取文件表头，生成侧边栏筛选面板
2. 记录文件总行数
3. 读取部分行并进行编码转换（如需）和解析显示
4. 用户勾选要筛选的列，点击筛选后显示已读取部分的筛选列
5. 显示竖向进度条（当前位置/文件最大行）
6. 用户拖动竖向进度条，实时读取文件、转换编码（如需）、解析、显示

## 开发步骤

### 阶段一：基础文件处理和初始化

#### 任务 1：实现 CSV 文件初始化读取
- [x] 创建 CsvReader 类用于处理 CSV 文件
- [x] 实现文件表头读取功能
- [x] 实现文件总行数计算功能
- [x] 创建初始化数据结构体（包含表头、总行数等信息）
- [x] 实现基础的 CSV 解析功能（逗号分隔）
- [x] **优化项：创建行映射表，记录每行在文件中的位置偏移量**

#### 任务 2：实现编码检测和转换
- [ ] 添加编码检测功能
- [ ] 实现常见编码（UTF-8, GBK, ASCII等）的转换
- [ ] 集成编码转换到文件读取流程中

### 阶段二：UI 设计和基础显示

#### 任务 3：设计主界面布局
- [x] 创建主窗口框架
- [x] 添加表格视图用于显示 CSV 数据
- [x] 添加侧边栏用于筛选控制
- [ ] 添加垂直进度条
- [x] 设计状态栏显示基本信息

#### 任务 4：实现基础数据显示
- [x] 实现数据模型（QAbstractTableModel 或类似）
- [ ] 实现分页加载机制（只加载当前显示需要的数据）
- [x] 连接 CsvReader 和数据模型
- [x] 实现基本的表格显示功能

### 阶段三：筛选功能实现

#### 任务 5：实现筛选面板
- [x] 在侧边栏动态生成筛选控件（基于表头）
- [x] 实现筛选条件选择功能
- [x] 添加"应用筛选"按钮

#### 任务 6：实现筛选逻辑
- [x] 实现按列筛选功能
- [ ] 更新显示模型以只显示筛选结果
- [ ] 优化筛选性能

### 阶段四：进度控制和大文件浏览

#### 任务 7：实现垂直进度条
- [ ] 添加垂直滚动条控件
- [ ] 实现位置指示功能（当前位置/总行数）
- [ ] 添加位置标签显示

#### 任务 8：实现动态文件读取
- [ ] 实现根据进度条位置动态读取文件片段
- [ ] 集成编码转换到动态读取流程
- [ ] 实现数据实时更新显示
- [x] **使用行映射表优化文件读取性能**

### 阶段五：优化和完善

#### 任务 9：性能优化
- [ ] 优化大文件读取性能
- [ ] 优化内存使用
- [ ] 实现文件缓存机制

#### 任务 10：用户体验优化
- [ ] 添加加载提示
- [ ] 优化界面交互
- [ ] 添加错误处理和提示

#### 任务 11：测试和完善
- [ ] 进行功能测试
- [ ] 进行大文件性能测试
- [ ] 修复发现的问题

## 详细开发方案

### 1. 自定义垂直滚动条实现
- 不使用 QTableView 自带的滚动条
- 使用 QScrollBar 控件创建自定义垂直滚动条
- 滚动条的范围设置为文件总行数
- 滚动条的页面步长设置为界面可显示的最大行数
- 滚动条的单步设置为1行

### 2. 数据读取和缓存机制
- 初始化时读取部分数据（界面显示最大行数 + 余量，如50%）
- 实现数据缓存机制，缓存已读取的数据块
- 缓存策略采用LRU（最近最少使用）算法
- 缓存大小限制，避免占用过多内存

### 3. 编码处理
- 实现 UTF-8 编码检测和处理
- 实现 GB2312/GBK 编码检测和处理
- 在读取数据时自动检测并转换编码
- 提供编码手动选择功能作为备选方案

### 4. 动态筛选支持
- 实现筛选列变更检测机制
- 当筛选列变更时，重新加载并显示数据
- 保持滚动条位置不变
- 优化筛选列变更时的性能

### 5. 滚动条优化处理
- 实现滚动条拖动时的防抖动机制
- 用户快速拖动时，只加载最终停留位置的数据
- 使用 QTimer 实现延迟加载，避免频繁读取文件
- 添加加载状态提示，提高用户体验

### 6. 内存管理优化
- 实现智能内存管理，根据可用内存动态调整缓存大小
- 及时释放不再需要的数据
- 避免内存泄漏

### 7. 多线程处理
- 使用 Qt 的线程机制处理耗时操作
- 文件读取操作在后台线程进行
- 编码转换在后台线程进行
- 数据解析在后台线程进行
- 模型更新通过信号槽机制与主线程通信
- 界面保持响应性

### 8. 性能监控和统计
- 识别可能耗时较长的操作阶段：
  - 文件初始化和表头读取
  - 编码检测和转换
  - 数据读取和解析
  - 模型更新和界面刷新
  - 缓存管理操作
- 在状态栏实时显示各阶段耗时
- 提供详细的性能统计数据
- 实现性能瓶颈分析功能

## 补充建议和注意事项

### 1. 文件锁定问题
- 考虑文件可能被其他程序锁定的情况
- 实现文件访问错误处理机制

### 2. 大数值处理
- 考虑文件行数超过 int 范围的情况，使用 qint64 类型
- 处理大文件时的数值溢出问题

### 3. 异常处理
- 实现完善的异常处理机制
- 处理文件损坏、格式错误等情况
- 提供友好的错误提示

### 4. 性能监控
- 添加性能监控功能，记录各操作的耗时
- 提供性能统计信息显示

### 5. 用户体验优化
- 添加加载进度提示
- 实现平滑滚动效果
- 提供快捷键支持

### 6. 配置管理
- 实现用户配置保存和加载
- 支持自定义界面设置

### 7. 测试考虑
- 准备不同编码格式的测试文件
- 准备大文件进行性能测试
- 测试边界情况（空文件、单行文件等）

## 技术要点

1. 使用 Qt 框架实现跨平台支持
2. 采用 C++17 标准编写
3. 实现高效的文件读取和内存管理策略
4. 实现编码检测和转换功能
5. 使用 Qt 的模型/视图架构
6. 实现异步加载以保持界面响应性
7. **实现行映射表优化随机访问性能**

## 预期成果

一个能够高效处理大体积 CSV 文件的查看器，具有友好的用户界面和流畅的浏览体验，支持筛选和编码转换功能。